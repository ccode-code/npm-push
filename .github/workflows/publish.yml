# GitHub Actions 工作流：自动发布到 npm
# 此工作流会在推送版本 tag 或手动触发时，自动运行测试、构建并发布包到 npm

name: Publish to npm

# 工作流触发条件
on:
  # 自动触发：当推送以 'v' 开头的 tag 时触发（例如: v1.0.0, v1.2.3）
  # 使用方式：git tag v1.0.0 && git push origin v1.0.0
  push:
    tags:
      - 'v*'  # 匹配所有以 'v' 开头的 tag

  # 手动触发：在 GitHub Actions 页面手动运行工作流
  # 允许在 Actions 页面手动触发发布流程，可以用于紧急发布或重新发布
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to publish (e.g., v1.0.0)'
        required: false
        type: string

# 定义工作流中的任务
jobs:
  # 发布任务：负责测试、构建和发布到 npm
  publish:
    # 运行环境：使用最新的 Ubuntu LTS 版本
    runs-on: ubuntu-latest

    # 权限配置：定义工作流需要的权限
    permissions:
      contents: read   # 读取仓库内容（用于检出代码）
      id-token: write # 写入 ID token（用于 npm 发布认证，支持 OIDC 认证）

    # 执行步骤：按顺序执行以下步骤
    steps:
      # 步骤 1: 检出代码
      # 从 GitHub 仓库检出代码到工作流运行器
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          # 获取完整的 Git 历史记录（而不是浅克隆）
          # 这对于生成 changelog 或进行版本比较很有用
          fetch-depth: 0

      # 步骤 2: 设置 Bun 运行环境
      # 安装并配置 Bun，这是项目使用的 JavaScript 运行时和包管理器
      - name: 设置 Bun
        uses: oven-sh/setup-bun@v2
        with:
          # 使用最新版本的 Bun
          # 也可以指定具体版本，如: "1.0.0"
          bun-version: latest

      # 步骤 3: 安装项目依赖
      # 使用 Bun 安装 package.json 中定义的所有依赖
      - name: 安装依赖
        run: bun install --frozen-lockfile
        # --frozen-lockfile: 使用锁定的依赖版本，确保构建的一致性
        # 如果 lockfile 与 package.json 不匹配，会失败而不是更新 lockfile

      # 步骤 4: 运行测试套件
      # 执行所有测试用例，确保代码质量
      # 如果测试失败，工作流会停止，不会继续发布
      # - name: 运行测试
      #   run: bun test

      # 步骤 5: 构建项目
      # 将 TypeScript 源代码编译为 JavaScript，生成 dist 目录
      # 构建产物会被发布到 npm
      - name: 构建项目
        run: bun run build

      # 步骤 6: 配置 npm 发布环境
      # 设置 Node.js 和 npm，配置 npm registry
      - name: 配置 npm 发布
        uses: actions/setup-node@v4
        with:
          # npm registry 地址：使用官方 npm registry
          registry-url: 'https://registry.npmjs.org'
          # scope: 如果包有 scope（如 @username/package），需要设置 scope
          # 本项目没有 scope，所以设置为空字符串
          scope: ''

      # 步骤 7: 发布包到 npm
      # 将构建好的包发布到 npm registry
      - name: 发布到 npm
        run: npm publish --access public
        env:
          # npm 认证 token
          # 需要在 GitHub 仓库的 Settings → Secrets 中添加 NPM_TOKEN
          # 获取方式：npmjs.com → Access Tokens → Generate New Token (Classic)
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        # 如果发布失败，工作流应该停止（不继续执行后续步骤）
        continue-on-error: false

      # 步骤 8: 创建 GitHub Release
      # 在 GitHub 上创建 Release，方便用户查看版本变更
      # 只在通过 tag 触发时创建（手动触发时不创建）
      - name: 创建 GitHub Release
        # 条件判断：只有当触发来源是 tag 时才执行
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          # Release 关联的 tag 名称（例如: v1.0.0）
          tag_name: ${{ github.ref_name }}
          # Release 标题
          name: Release ${{ github.ref_name }}
          # Release 描述内容（Markdown 格式）
          body: |
            ## 变更内容
            
            查看 [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md) 了解详细变更内容。
          # 是否为草稿（false = 立即发布）
          draft: false
          # 是否为预发布版本（false = 正式版本）
          prerelease: false
        env:
          # GitHub token：用于创建 Release
          # GITHUB_TOKEN 是 GitHub Actions 自动提供的，无需手动配置
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
